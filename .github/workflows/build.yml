name: build

on:
  push:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@1e204e9a9253d643386038d443f96446fa156a97 # tag=v2.3.5

      - name: prepare
        run: pwsh ./tools/prepare.ps1

      - name: build
        run: pwsh ./tools/build.ps1

      - uses: actions/upload-artifact@97b7dace6c8d860ce9708aba808be6a2ee4cbc3a # tag=v2.0.1
        with:
          name: packages
          path: bin/*.nupkg

      - name: deploy github.com
        if: ${{ github.ref_type == 'tag' }}
        run: find bin -name '*.nupkg' -exec dotnet nuget push {} -s $NUGET_SOURCE -k $NUGET_KEY --skip-duplicate --force-english-output \;
        shell: bash
        env:
          NUGET_SOURCE: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
          NUGET_KEY: ${{ secrets.GITHUB_TOKEN }}

      - name: deploy nuget.org
        if: ${{ github.ref_type == 'tag' }}
        run: find bin -name '*.nupkg' -exec dotnet nuget push {} -s $NUGET_SOURCE -k $NUGET_KEY --skip-duplicate --force-english-output \;
        shell: bash
        env:
          NUGET_SOURCE: https://api.nuget.org/v3/index.json
          NUGET_KEY: ${{ secrets.NUGET_API_KEY }}


